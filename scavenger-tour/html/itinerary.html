<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>My Itinerary - VoteCraft Tour</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom styles -->
    <link rel="stylesheet" href="../css/scavenger-tour.css">

    <style>
        /* Itinerary-specific styles */
        .itinerary-item {
            background: #1f2937;
            border-radius: 0.75rem;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .itinerary-item.visited {
            opacity: 0.7;
        }

        .itinerary-item.visited .item-name {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .itinerary-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .itinerary-header:hover {
            background: #374151;
        }

        .checkbox-container {
            width: 24px;
            height: 24px;
            border: 2px solid #6b7280;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 1rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .checkbox-container:hover {
            border-color: #22c55e;
        }

        .checkbox-container.checked {
            background: #22c55e;
            border-color: #22c55e;
        }

        .itinerary-content {
            flex: 1;
            min-width: 0;
        }

        .itinerary-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #111827;
        }

        .itinerary-item.open .itinerary-details {
            max-height: 300px;
        }

        .itinerary-item.open .chevron-icon {
            transform: rotate(180deg);
        }

        .chevron-icon {
            transition: transform 0.2s ease;
        }

        .directions-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: opacity 0.15s ease;
        }

        .directions-btn:hover {
            opacity: 0.85;
        }

        .progress-bar-bg {
            background: #374151;
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
        }
    </style>
</head>
<body>
    <div id="app" class="max-w-2xl mx-auto bg-black min-h-screen">
        <!-- Top Bar -->
        <div class="top-bar bg-white px-4 py-2 flex items-center justify-between shadow-sm sticky top-0 z-30">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: #4269FF;">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                </div>
                <div class="text-xl font-bold">
                    <span class="text-gray-800">My</span>
                    <span style="color: #4269FF;">Itinerary</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="px-4 pt-4 pb-24">
            <!-- Back Button -->
            <a href="scavenger-tour.html" id="back-link" class="inline-flex items-center gap-2 text-white mb-4 px-4 py-2 border border-gray-700 rounded-xl hover:bg-gray-800 transition-colors">
                <span>&larr;</span>
                <span class="text-sm">Back to Tour</span>
            </a>

            <!-- Tour Name -->
            <p id="tour-name" class="text-gray-400 text-sm mb-6"></p>

            <!-- Progress Section -->
            <div id="progress-section" class="mb-6 hidden">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white text-sm font-semibold">Progress</span>
                    <span id="progress-text" class="text-gray-400 text-sm">0 of 0 completed</span>
                </div>
                <div class="progress-bar-bg">
                    <div id="progress-bar" class="progress-bar-fill" style="width: 0%; background: #22c55e;"></div>
                </div>
            </div>

            <!-- Itinerary List -->
            <div id="itinerary-list"></div>

            <!-- Empty State -->
            <div id="empty-state" class="empty-state hidden">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center" style="background: rgba(66, 105, 255, 0.2);">
                    <svg class="w-10 h-10" style="color: #4269FF;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                </div>
                <h2 class="text-white text-xl font-bold mb-2">No stops added yet</h2>
                <p class="text-gray-400 text-sm mb-6">Explore the tour and add locations to your itinerary</p>
                <a href="scavenger-tour.html" id="browse-link" class="inline-flex items-center gap-2 text-white font-semibold px-6 py-3 rounded-xl" style="background: #4269FF;">
                    Browse Tour
                </a>
            </div>
        </div>
    </div>

    <!-- Location Data -->
    <script src="../js/scavenger-tour-data.js"></script>

    <!-- Page JavaScript -->
    <script>
    (function() {
        'use strict';

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const tourId = urlParams.get('tour') || 'civic-sampler';

        // Update back link and browse link
        document.getElementById('back-link').href = `scavenger-tour.html?tour=${tourId}`;
        document.getElementById('browse-link').href = `scavenger-tour.html?tour=${tourId}`;

        // Get tour data
        const tourData = ALL_TOURS[tourId] || PLANETUNE_PLAYLISTS;
        const tourNames = {
            'civic-sampler': 'Freedom Trail Sampler',
            'healthcare': 'Healthcare Justice Tour',
            'voting-rights': 'Voting Rights Tour',
            'art-action': 'ART ACTION TOUR'
        };
        document.getElementById('tour-name').textContent = tourNames[tourId] || 'Civic Tour';

        // LocalStorage key
        const STORAGE_KEY = 'votecraft_itinerary';

        // Get itinerary from localStorage
        function getItinerary() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    return JSON.parse(data);
                }
            } catch (e) {
                console.error('Error reading itinerary:', e);
            }
            return { tourId: tourId, stops: [], visited: [] };
        }

        // Save itinerary to localStorage
        function saveItinerary(itinerary) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(itinerary));
            } catch (e) {
                console.error('Error saving itinerary:', e);
            }
        }

        // Toggle visited state
        window.toggleVisited = function(stopId, event) {
            event.stopPropagation();
            const itinerary = getItinerary();
            const visitedIndex = itinerary.visited.indexOf(stopId);

            if (visitedIndex === -1) {
                itinerary.visited.push(stopId);
            } else {
                itinerary.visited.splice(visitedIndex, 1);
            }

            saveItinerary(itinerary);
            renderItinerary();
        };

        // Toggle accordion
        window.toggleAccordion = function(stopId) {
            const item = document.querySelector(`[data-stop-id="${stopId}"]`);
            if (item) {
                item.classList.toggle('open');
            }
        };

        // Open directions
        window.openDirections = function(lat, lng, name) {
            // Detect iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            let url;
            if (isIOS) {
                // Apple Maps with walking directions
                url = `maps://maps.apple.com/?daddr=${lat},${lng}&dirflg=w`;
            } else {
                // Google Maps with walking directions
                url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=walking`;
            }

            window.open(url, '_blank');
        };

        // Render itinerary
        function renderItinerary() {
            const itinerary = getItinerary();
            const listContainer = document.getElementById('itinerary-list');
            const emptyState = document.getElementById('empty-state');
            const progressSection = document.getElementById('progress-section');

            // Filter stops for current tour
            const stops = itinerary.stops.filter(stopId => {
                return tourData.some(location => location.id === stopId);
            });

            if (stops.length === 0) {
                listContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                progressSection.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            progressSection.classList.remove('hidden');

            // Update progress
            const visitedCount = stops.filter(id => itinerary.visited.includes(id)).length;
            document.getElementById('progress-text').textContent = `${visitedCount} of ${stops.length} completed`;
            document.getElementById('progress-bar').style.width = `${(visitedCount / stops.length) * 100}%`;

            // Render items
            let html = '';
            stops.forEach(stopId => {
                const location = tourData.find(l => l.id === stopId);
                if (!location) return;

                const isVisited = itinerary.visited.includes(stopId);
                const theme = location.civicTheme;
                const themeColor = theme ? theme.color : '#22c55e';

                html += `
                <div class="itinerary-item ${isVisited ? 'visited' : ''}" data-stop-id="${stopId}">
                    <div class="itinerary-header" onclick="toggleAccordion(${stopId})">
                        <div class="checkbox-container ${isVisited ? 'checked' : ''}" onclick="toggleVisited(${stopId}, event)">
                            ${isVisited ? `
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                </svg>
                            ` : ''}
                        </div>
                        <div class="itinerary-content">
                            <h3 class="item-name text-white font-semibold mb-1">${location.name}</h3>
                            <p class="text-gray-400 text-sm">${location.location}</p>
                        </div>
                        ${theme ? `
                            <span class="text-xs font-bold px-2 py-1 rounded-full mr-3" style="background: ${themeColor}20; color: ${themeColor};">
                                ${theme.name}
                            </span>
                        ` : ''}
                        <svg class="chevron-icon w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    <div class="itinerary-details">
                        <div class="p-4 border-t border-gray-800">
                            <p class="text-gray-300 text-sm mb-4">${location.description.substring(0, 150)}...</p>
                            <div class="flex gap-3">
                                <button onclick="openDirections(${location.coordinates[0]}, ${location.coordinates[1]}, '${location.name.replace(/'/g, "\\'")}')"
                                        class="directions-btn flex-1 text-white text-sm" style="background: ${themeColor};">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    Get Directions
                                </button>
                                <a href="location-detail.html?id=${stopId}&tour=${tourId}"
                                   class="directions-btn text-white text-sm border border-gray-600 hover:bg-gray-700">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        // Initial render
        renderItinerary();
    })();
    </script>
</body>
</html>
