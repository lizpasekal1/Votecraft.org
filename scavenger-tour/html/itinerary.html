<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>My Itinerary - VoteCraft Tour</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom styles -->
    <link rel="stylesheet" href="../css/scavenger-tour.css">

    <style>
        /* Itinerary-specific styles */
        .itinerary-item {
            background: #1f2937;
            border-radius: 0.75rem;
            overflow: hidden;
            margin-bottom: 0.75rem;
            transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
            touch-action: none;
        }

        .itinerary-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .itinerary-item.drag-over {
            border: 2px dashed #4269FF;
            background: rgba(66, 105, 255, 0.1);
        }

        .itinerary-item.visited {
            opacity: 0.7;
        }

        .itinerary-item.visited .item-name {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .itinerary-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            padding-left: 0.5rem;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .itinerary-header:hover {
            background: #374151;
        }

        .drag-handle {
            width: 32px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            color: #6b7280;
            flex-shrink: 0;
            touch-action: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle:hover {
            color: #9ca3af;
        }

        .stop-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 700;
            flex-shrink: 0;
            margin-right: 0.75rem;
            color: white;
        }

        .checkbox-container {
            width: 24px;
            height: 24px;
            border: 2px solid #6b7280;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 0.75rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .checkbox-container:hover {
            border-color: #22c55e;
        }

        .checkbox-container.checked {
            background: #22c55e;
            border-color: #22c55e;
        }

        .itinerary-content {
            flex: 1;
            min-width: 0;
        }

        .itinerary-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #111827;
        }

        .itinerary-item.open .itinerary-details {
            max-height: 300px;
        }

        .itinerary-item.open .chevron-icon {
            transform: rotate(180deg);
        }

        .chevron-icon {
            transition: transform 0.2s ease;
        }

        .directions-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: opacity 0.15s ease;
        }

        .directions-btn:hover {
            opacity: 0.85;
        }

        .progress-bar-bg {
            background: #374151;
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease;
        }

        .drag-hint {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(66, 105, 255, 0.1);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(66, 105, 255, 0.3);
        }

        /* Touch device improvements */
        @media (pointer: coarse) {
            .drag-handle {
                width: 44px;
                height: 48px;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="max-w-2xl mx-auto bg-black min-h-screen">
        <!-- Top Bar -->
        <div class="top-bar bg-white px-4 py-2 flex items-center justify-between shadow-sm sticky top-0 z-30">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: #4269FF;">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                </div>
                <div class="text-xl font-bold">
                    <span class="text-gray-800">My</span>
                    <span style="color: #4269FF;">Itinerary</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="px-4 pt-4 pb-24">
            <!-- Back Button -->
            <a href="scavenger-tour.html" id="back-link" class="inline-flex items-center gap-2 text-white mb-4 px-4 py-2 border border-gray-700 rounded-xl hover:bg-gray-800 transition-colors">
                <span>&larr;</span>
                <span class="text-sm">Back to Tour</span>
            </a>

            <!-- Tour Name -->
            <p id="tour-name" class="text-gray-400 text-sm mb-4"></p>

            <!-- Drag Hint -->
            <div class="drag-hint">
                <svg class="w-5 h-5" style="color: #4269FF;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16"/>
                </svg>
                <span class="text-sm" style="color: #4269FF;">Drag to reorder your walking route</span>
            </div>

            <!-- Progress Section -->
            <div id="progress-section" class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white text-sm font-semibold">Progress</span>
                    <span id="progress-text" class="text-gray-400 text-sm">0 of 0 completed</span>
                </div>
                <div class="progress-bar-bg">
                    <div id="progress-bar" class="progress-bar-fill" style="width: 0%; background: #22c55e;"></div>
                </div>
            </div>

            <!-- Itinerary List -->
            <div id="itinerary-list"></div>
        </div>
    </div>

    <!-- Location Data -->
    <script src="../js/scavenger-tour-data.js"></script>

    <!-- Page JavaScript -->
    <script>
    (function() {
        'use strict';

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const tourId = urlParams.get('tour') || 'civic-sampler';

        // Update back link
        document.getElementById('back-link').href = `scavenger-tour.html?tour=${tourId}`;

        // Get tour data
        const tourData = ALL_TOURS[tourId] || PLANETUNE_PLAYLISTS;
        const tourNames = {
            'civic-sampler': 'Freedom Trail Sampler',
            'healthcare': 'Healthcare Justice Tour',
            'voting-rights': 'Voting Rights Tour',
            'art-action': 'ART ACTION TOUR'
        };
        document.getElementById('tour-name').textContent = tourNames[tourId] || 'Civic Tour';

        // LocalStorage key (per tour)
        const STORAGE_KEY = `votecraft_itinerary_${tourId}`;

        // Get itinerary from localStorage
        function getItinerary() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    return JSON.parse(data);
                }
            } catch (e) {
                console.error('Error reading itinerary:', e);
            }
            // Default: all stops in original order
            return {
                tourId: tourId,
                order: tourData.map(loc => loc.id),
                visited: []
            };
        }

        // Save itinerary to localStorage
        function saveItinerary(itinerary) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(itinerary));
            } catch (e) {
                console.error('Error saving itinerary:', e);
            }
        }

        // Drag and drop state
        let draggedItem = null;
        let draggedIndex = null;

        // Toggle visited state
        window.toggleVisited = function(stopId, event) {
            event.stopPropagation();
            const itinerary = getItinerary();
            const visitedIndex = itinerary.visited.indexOf(stopId);

            if (visitedIndex === -1) {
                itinerary.visited.push(stopId);
            } else {
                itinerary.visited.splice(visitedIndex, 1);
            }

            saveItinerary(itinerary);
            renderItinerary();
        };

        // Toggle accordion
        window.toggleAccordion = function(stopId) {
            const item = document.querySelector(`[data-stop-id="${stopId}"]`);
            if (item) {
                item.classList.toggle('open');
            }
        };

        // Open directions
        window.openDirections = function(lat, lng, name) {
            // Detect iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            let url;
            if (isIOS) {
                // Apple Maps with walking directions
                url = `maps://maps.apple.com/?daddr=${lat},${lng}&dirflg=w`;
            } else {
                // Google Maps with walking directions
                url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=walking`;
            }

            window.open(url, '_blank');
        };

        // Drag handlers
        function handleDragStart(e) {
            draggedItem = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.stopId);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.itinerary-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
            draggedIndex = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();

            this.classList.remove('drag-over');

            if (draggedItem !== this) {
                const dropIndex = parseInt(this.dataset.index);
                const itinerary = getItinerary();

                // Reorder array
                const movedId = itinerary.order.splice(draggedIndex, 1)[0];
                itinerary.order.splice(dropIndex, 0, movedId);

                saveItinerary(itinerary);
                renderItinerary();
            }

            return false;
        }

        // Touch drag support
        let touchStartY = 0;
        let touchCurrentItem = null;
        let touchClone = null;
        let touchStartIndex = null;

        function handleTouchStart(e) {
            const handle = e.target.closest('.drag-handle');
            if (!handle) return;

            touchCurrentItem = this;
            touchStartIndex = parseInt(this.dataset.index);
            touchStartY = e.touches[0].clientY;

            // Create visual clone
            touchClone = this.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.zIndex = '1000';
            touchClone.style.width = this.offsetWidth + 'px';
            touchClone.style.opacity = '0.9';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.transform = 'scale(1.02)';
            touchClone.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.3)';
            document.body.appendChild(touchClone);

            this.classList.add('dragging');

            updateTouchClonePosition(e.touches[0].clientY);
        }

        function handleTouchMove(e) {
            if (!touchCurrentItem) return;
            e.preventDefault();

            const touch = e.touches[0];
            updateTouchClonePosition(touch.clientY);

            // Find item under touch
            const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const itemBelow = elemBelow ? elemBelow.closest('.itinerary-item') : null;

            document.querySelectorAll('.itinerary-item').forEach(item => {
                item.classList.remove('drag-over');
            });

            if (itemBelow && itemBelow !== touchCurrentItem) {
                itemBelow.classList.add('drag-over');
            }
        }

        function handleTouchEnd(e) {
            if (!touchCurrentItem) return;

            // Find drop target
            const touch = e.changedTouches[0];
            const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const dropTarget = elemBelow ? elemBelow.closest('.itinerary-item') : null;

            if (dropTarget && dropTarget !== touchCurrentItem) {
                const dropIndex = parseInt(dropTarget.dataset.index);
                const itinerary = getItinerary();

                const movedId = itinerary.order.splice(touchStartIndex, 1)[0];
                itinerary.order.splice(dropIndex, 0, movedId);

                saveItinerary(itinerary);
                renderItinerary();
            }

            // Cleanup
            if (touchClone) {
                touchClone.remove();
                touchClone = null;
            }

            document.querySelectorAll('.itinerary-item').forEach(item => {
                item.classList.remove('dragging', 'drag-over');
            });

            touchCurrentItem = null;
            touchStartIndex = null;
        }

        function updateTouchClonePosition(y) {
            if (touchClone) {
                const rect = touchCurrentItem.getBoundingClientRect();
                touchClone.style.left = rect.left + 'px';
                touchClone.style.top = (y - touchClone.offsetHeight / 2) + 'px';
            }
        }

        // Render itinerary
        function renderItinerary() {
            const itinerary = getItinerary();
            const listContainer = document.getElementById('itinerary-list');

            // Use custom order or default to all tour stops
            let orderedIds = itinerary.order && itinerary.order.length > 0
                ? itinerary.order
                : tourData.map(loc => loc.id);

            // Ensure all tour stops are included (in case new ones were added)
            const allTourIds = tourData.map(loc => loc.id);
            allTourIds.forEach(id => {
                if (!orderedIds.includes(id)) {
                    orderedIds.push(id);
                }
            });

            // Filter to only valid stops
            orderedIds = orderedIds.filter(id => tourData.some(loc => loc.id === id));

            // Update progress
            const visitedCount = orderedIds.filter(id => itinerary.visited.includes(id)).length;
            document.getElementById('progress-text').textContent = `${visitedCount} of ${orderedIds.length} completed`;
            document.getElementById('progress-bar').style.width = `${(visitedCount / orderedIds.length) * 100}%`;

            // Render items
            let html = '';
            orderedIds.forEach((stopId, index) => {
                const location = tourData.find(l => l.id === stopId);
                if (!location) return;

                const isVisited = itinerary.visited.includes(stopId);
                const theme = location.civicTheme;
                const themeColor = theme ? theme.color : '#22c55e';

                html += `
                <div class="itinerary-item ${isVisited ? 'visited' : ''}" data-stop-id="${stopId}" data-index="${index}" draggable="true">
                    <div class="itinerary-header">
                        <div class="drag-handle">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16"/>
                            </svg>
                        </div>
                        <div class="stop-number" style="background: ${themeColor};">${index + 1}</div>
                        <div class="checkbox-container ${isVisited ? 'checked' : ''}" onclick="toggleVisited(${stopId}, event)">
                            ${isVisited ? `
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                </svg>
                            ` : ''}
                        </div>
                        <div class="itinerary-content" onclick="toggleAccordion(${stopId})">
                            <h3 class="item-name text-white font-semibold mb-1">${location.name}</h3>
                            <p class="text-gray-400 text-sm">${location.location}</p>
                        </div>
                        <svg class="chevron-icon w-5 h-5 text-gray-400 flex-shrink-0" onclick="toggleAccordion(${stopId})" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    <div class="itinerary-details">
                        <div class="p-4 border-t border-gray-800">
                            <p class="text-gray-300 text-sm mb-4">${location.description.substring(0, 150)}...</p>
                            <div class="flex gap-3">
                                <button onclick="openDirections(${location.coordinates[0]}, ${location.coordinates[1]}, '${location.name.replace(/'/g, "\\'")}')"
                                        class="directions-btn flex-1 text-white text-sm" style="background: ${themeColor};">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    Get Directions
                                </button>
                                <a href="location-detail.html?id=${stopId}&tour=${tourId}"
                                   class="directions-btn text-white text-sm border border-gray-600 hover:bg-gray-700">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });

            listContainer.innerHTML = html;

            // Attach drag event listeners
            document.querySelectorAll('.itinerary-item').forEach(item => {
                // Mouse drag
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);

                // Touch drag
                item.addEventListener('touchstart', handleTouchStart, { passive: false });
                item.addEventListener('touchmove', handleTouchMove, { passive: false });
                item.addEventListener('touchend', handleTouchEnd);
            });
        }

        // Initial render
        renderItinerary();
    })();
    </script>
</body>
</html>
