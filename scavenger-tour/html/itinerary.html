<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>My Itinerary - VoteCraft Tour</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom styles -->
    <link rel="stylesheet" href="../css/scavenger-tour.css">

    <style>
        /* Itinerary-specific styles */
        .itinerary-item {
            background: #1f2937;
            border-radius: 0.75rem;
            overflow: hidden;
            margin-bottom: 0.75rem;
            transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
            touch-action: none;
        }

        .itinerary-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .itinerary-item.drag-over {
            border: 2px dashed #4269FF;
            background: rgba(66, 105, 255, 0.1);
        }

        .itinerary-item.visited {
            opacity: 0.7;
        }

        .itinerary-item.visited .item-name {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .itinerary-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            padding-left: 0.5rem;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .itinerary-header:hover {
            background: #374151;
        }

        .drag-handle {
            width: 32px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            color: #6b7280;
            flex-shrink: 0;
            touch-action: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle:hover {
            color: #9ca3af;
        }

        .stop-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 700;
            flex-shrink: 0;
            margin-right: 0.75rem;
            color: white;
        }

        .checkbox-container {
            width: 24px;
            height: 24px;
            border: 2px solid #6b7280;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 0.75rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .checkbox-container:hover {
            border-color: #22c55e;
        }

        .checkbox-container.checked {
            background: #22c55e;
            border-color: #22c55e;
        }

        .itinerary-content {
            flex: 1;
            min-width: 0;
        }

        .itinerary-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #111827;
        }

        .itinerary-item.open .itinerary-details {
            max-height: 300px;
        }

        .itinerary-item.open .chevron-icon {
            transform: rotate(180deg);
        }

        .chevron-icon {
            transition: transform 0.2s ease;
        }

        .directions-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: opacity 0.15s ease;
        }

        .directions-btn:hover {
            opacity: 0.85;
        }

        .progress-bar-bg {
            background: #374151;
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease;
        }

        .drag-hint {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(66, 105, 255, 0.1);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(66, 105, 255, 0.3);
        }

        /* Touch device improvements */
        @media (pointer: coarse) {
            .drag-handle {
                width: 44px;
                height: 48px;
            }
        }

        /* Directions Modal */
        .directions-modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
        }

        .directions-modal-header {
            background: #1f2937;
            padding: 1rem;
            padding-top: calc(1rem + env(safe-area-inset-top, 0px));
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .directions-map-container {
            flex: 1;
            position: relative;
            min-height: 300px;
        }

        #directions-map {
            width: 100%;
            height: 100%;
        }

        .directions-info {
            background: #111827;
            padding: 1rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
            flex-shrink: 0;
        }

        .directions-loading {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #111827;
            z-index: 10;
        }

        .directions-loading.hidden {
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #374151;
            border-top-color: #4269FF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hide default routing machine controls */
        .leaflet-routing-container {
            display: none;
        }

        .route-summary {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .route-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .route-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .route-stat-label {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .route-instructions {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 0.75rem;
        }

        .route-step {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #374151;
        }

        .route-step:last-child {
            border-bottom: none;
        }

        .route-step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .route-step-text {
            font-size: 0.875rem;
            color: #d1d5db;
        }

        .route-step-distance {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div id="app" class="max-w-2xl mx-auto bg-black min-h-screen">
        <!-- Top Bar -->
        <div class="top-bar bg-white px-4 py-2 shadow-sm sticky top-0 z-30 relative">
            <!-- Centered Logo -->
            <div class="flex items-center justify-center gap-2 py-1">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: #4269FF;">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                </div>
                <div class="text-xl font-bold">
                    <span class="text-gray-800">My</span>
                    <span style="color: #4269FF;">Itinerary</span>
                </div>
            </div>
            <!-- Menu Button (absolute right) -->
            <button id="btn-menu" class="absolute right-4 top-1/2 -translate-y-1/2 p-2 hover:bg-gray-100 rounded-lg">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
        </div>

        <!-- Main Content -->
        <div class="px-4 pt-4 pb-24">
            <!-- Back Button -->
            <a href="scavenger-tour.html" id="back-link" class="inline-flex items-center gap-2 text-white mb-4 px-4 py-2 border border-gray-700 rounded-xl hover:bg-gray-800 transition-colors">
                <span>&larr;</span>
                <span class="text-sm">Back to Tour</span>
            </a>

            <!-- Tour Name -->
            <p id="tour-name" class="text-gray-400 text-sm mb-4"></p>

            <!-- Drag Hint -->
            <div class="drag-hint">
                <svg class="w-5 h-5" style="color: #4269FF;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16"/>
                </svg>
                <span class="text-sm" style="color: #4269FF;">Drag to reorder your walking route</span>
            </div>

            <!-- Progress Section -->
            <div id="progress-section" class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white text-sm font-semibold">Progress</span>
                    <span id="progress-text" class="text-gray-400 text-sm">0 of 0 completed</span>
                </div>
                <div class="progress-bar-bg">
                    <div id="progress-bar" class="progress-bar-fill" style="width: 0%; background: #22c55e;"></div>
                </div>
            </div>

            <!-- Itinerary List -->
            <div id="itinerary-list"></div>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modals"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

    <!-- Location Data -->
    <script src="../js/scavenger-tour-data.js"></script>

    <!-- Page JavaScript -->
    <script>
    (function() {
        'use strict';

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const tourId = urlParams.get('tour') || 'civic-sampler';

        // Update back link
        document.getElementById('back-link').href = `scavenger-tour.html?tour=${tourId}`;

        // Get tour data
        const tourData = ALL_TOURS[tourId] || PLANETUNE_PLAYLISTS;
        const tourNames = {
            'civic-sampler': 'Freedom Trail Sampler',
            'healthcare': 'Healthcare Justice Tour',
            'voting-rights': 'Voting Rights Tour',
            'art-action': 'ART ACTION TOUR'
        };
        document.getElementById('tour-name').textContent = tourNames[tourId] || 'Civic Tour';

        // LocalStorage key (per tour)
        const STORAGE_KEY = `votecraft_itinerary_${tourId}`;

        // Get itinerary from localStorage
        function getItinerary() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    return JSON.parse(data);
                }
            } catch (e) {
                console.error('Error reading itinerary:', e);
            }
            // Default: all stops in original order
            return {
                tourId: tourId,
                order: tourData.map(loc => loc.id),
                visited: []
            };
        }

        // Save itinerary to localStorage
        function saveItinerary(itinerary) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(itinerary));
            } catch (e) {
                console.error('Error saving itinerary:', e);
            }
        }

        // Drag and drop state
        let draggedItem = null;
        let draggedIndex = null;

        // Toggle visited state
        window.toggleVisited = function(stopId, event) {
            event.stopPropagation();
            const itinerary = getItinerary();
            const visitedIndex = itinerary.visited.indexOf(stopId);

            if (visitedIndex === -1) {
                itinerary.visited.push(stopId);
            } else {
                itinerary.visited.splice(visitedIndex, 1);
            }

            saveItinerary(itinerary);
            renderItinerary();
        };

        // Toggle accordion
        window.toggleAccordion = function(stopId) {
            const item = document.querySelector(`[data-stop-id="${stopId}"]`);
            if (item) {
                item.classList.toggle('open');
            }
        };

        // Directions modal state
        let directionsMap = null;
        let routingControl = null;

        // Open directions modal with in-app routing
        window.openDirections = function(destLat, destLng, name) {
            // Create modal HTML
            const modalHtml = `
                <div class="directions-modal" id="directions-modal">
                    <div class="directions-modal-header">
                        <div>
                            <h2 class="text-white font-bold text-lg">Directions</h2>
                            <p class="text-gray-400 text-sm">${name}</p>
                        </div>
                        <button onclick="closeDirectionsModal()" class="p-2 hover:bg-gray-700 rounded-full transition-colors">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="directions-map-container">
                        <div id="directions-map"></div>
                        <div class="directions-loading" id="directions-loading">
                            <div class="spinner"></div>
                            <p class="text-gray-400 mt-4">Getting your location...</p>
                        </div>
                    </div>
                    <div class="directions-info">
                        <div class="route-summary" id="route-summary">
                            <div class="route-stat">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                                <div>
                                    <div class="route-stat-value" id="route-distance">--</div>
                                    <div class="route-stat-label">Distance</div>
                                </div>
                            </div>
                            <div class="route-stat">
                                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div>
                                    <div class="route-stat-value" id="route-time">--</div>
                                    <div class="route-stat-label">Walking</div>
                                </div>
                            </div>
                        </div>
                        <div class="route-instructions" id="route-instructions"></div>
                    </div>
                </div>
            `;

            document.getElementById('modals').innerHTML = modalHtml;
            document.body.classList.add('drawer-open');

            // Initialize map centered on destination
            directionsMap = L.map('directions-map').setView([destLat, destLng], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(directionsMap);

            // Add destination marker
            const destMarker = L.marker([destLat, destLng]).addTo(directionsMap);
            destMarker.bindPopup(`<strong>${name}</strong>`).openPopup();

            // Get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;

                        // Hide loading
                        document.getElementById('directions-loading').classList.add('hidden');

                        // Add user marker
                        const userMarker = L.circleMarker([userLat, userLng], {
                            radius: 10,
                            fillColor: '#4269FF',
                            color: '#fff',
                            weight: 3,
                            opacity: 1,
                            fillOpacity: 1
                        }).addTo(directionsMap);
                        userMarker.bindPopup('You are here');

                        // Create routing
                        routingControl = L.Routing.control({
                            waypoints: [
                                L.latLng(userLat, userLng),
                                L.latLng(destLat, destLng)
                            ],
                            router: L.Routing.osrmv1({
                                serviceUrl: 'https://router.project-osrm.org/route/v1',
                                profile: 'foot'
                            }),
                            lineOptions: {
                                styles: [{ color: '#4269FF', weight: 5, opacity: 0.8 }]
                            },
                            createMarker: function() { return null; }, // Don't create default markers
                            addWaypoints: false,
                            routeWhileDragging: false,
                            fitSelectedRoutes: true,
                            showAlternatives: false
                        }).addTo(directionsMap);

                        // Listen for route found
                        routingControl.on('routesfound', function(e) {
                            const route = e.routes[0];
                            const distance = route.summary.totalDistance;
                            const time = route.summary.totalTime;

                            // Update summary
                            document.getElementById('route-distance').textContent = formatDistance(distance);
                            document.getElementById('route-time').textContent = formatTime(time);

                            // Build instructions
                            const instructionsHtml = route.instructions.slice(0, 10).map((instr, i) => `
                                <div class="route-step">
                                    <div class="route-step-number">${i + 1}</div>
                                    <div>
                                        <div class="route-step-text">${instr.text}</div>
                                        <div class="route-step-distance">${formatDistance(instr.distance)}</div>
                                    </div>
                                </div>
                            `).join('');

                            document.getElementById('route-instructions').innerHTML = instructionsHtml;
                        });

                        routingControl.on('routingerror', function(e) {
                            document.getElementById('route-instructions').innerHTML = `
                                <p class="text-gray-400 text-sm">Could not calculate route. Try opening in Maps app.</p>
                                <button onclick="openExternalMaps(${destLat}, ${destLng})" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">
                                    Open in Maps
                                </button>
                            `;
                        });
                    },
                    (error) => {
                        // Location error - show fallback
                        document.getElementById('directions-loading').innerHTML = `
                            <svg class="w-12 h-12 text-gray-500 mb-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <p class="text-gray-400 mb-4">Location access required for directions</p>
                            <button onclick="openExternalMaps(${destLat}, ${destLng})" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
                                Open in Maps App
                            </button>
                        `;
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                // No geolocation support
                document.getElementById('directions-loading').innerHTML = `
                    <p class="text-gray-400 mb-4">Geolocation not supported</p>
                    <button onclick="openExternalMaps(${destLat}, ${destLng})" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
                        Open in Maps App
                    </button>
                `;
            }
        };

        // Close directions modal
        window.closeDirectionsModal = function() {
            if (routingControl) {
                directionsMap.removeControl(routingControl);
                routingControl = null;
            }
            if (directionsMap) {
                directionsMap.remove();
                directionsMap = null;
            }
            document.getElementById('modals').innerHTML = '';
            document.body.classList.remove('drawer-open');
        };

        // Format distance
        function formatDistance(meters) {
            if (meters < 1000) {
                return Math.round(meters) + ' m';
            }
            const miles = meters / 1609.34;
            return miles.toFixed(1) + ' mi';
        }

        // Format time
        function formatTime(seconds) {
            const minutes = Math.round(seconds / 60);
            if (minutes < 60) {
                return minutes + ' min';
            }
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        // Fallback to external maps
        window.openExternalMaps = function(lat, lng) {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const url = isIOS
                ? `maps://maps.apple.com/?daddr=${lat},${lng}&dirflg=w`
                : `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=walking`;
            window.open(url, '_blank');
        };

        // Drag handlers
        function handleDragStart(e) {
            draggedItem = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.stopId);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.itinerary-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
            draggedIndex = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();

            this.classList.remove('drag-over');

            if (draggedItem !== this) {
                const dropIndex = parseInt(this.dataset.index);
                const itinerary = getItinerary();

                // Reorder array
                const movedId = itinerary.order.splice(draggedIndex, 1)[0];
                itinerary.order.splice(dropIndex, 0, movedId);

                saveItinerary(itinerary);
                renderItinerary();
            }

            return false;
        }

        // Touch drag support
        let touchStartY = 0;
        let touchCurrentItem = null;
        let touchClone = null;
        let touchStartIndex = null;

        function handleTouchStart(e) {
            const handle = e.target.closest('.drag-handle');
            if (!handle) return;

            touchCurrentItem = this;
            touchStartIndex = parseInt(this.dataset.index);
            touchStartY = e.touches[0].clientY;

            // Create visual clone
            touchClone = this.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.zIndex = '1000';
            touchClone.style.width = this.offsetWidth + 'px';
            touchClone.style.opacity = '0.9';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.transform = 'scale(1.02)';
            touchClone.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.3)';
            document.body.appendChild(touchClone);

            this.classList.add('dragging');

            updateTouchClonePosition(e.touches[0].clientY);
        }

        function handleTouchMove(e) {
            if (!touchCurrentItem) return;
            e.preventDefault();

            const touch = e.touches[0];
            updateTouchClonePosition(touch.clientY);

            // Find item under touch
            const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const itemBelow = elemBelow ? elemBelow.closest('.itinerary-item') : null;

            document.querySelectorAll('.itinerary-item').forEach(item => {
                item.classList.remove('drag-over');
            });

            if (itemBelow && itemBelow !== touchCurrentItem) {
                itemBelow.classList.add('drag-over');
            }
        }

        function handleTouchEnd(e) {
            if (!touchCurrentItem) return;

            // Find drop target
            const touch = e.changedTouches[0];
            const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const dropTarget = elemBelow ? elemBelow.closest('.itinerary-item') : null;

            if (dropTarget && dropTarget !== touchCurrentItem) {
                const dropIndex = parseInt(dropTarget.dataset.index);
                const itinerary = getItinerary();

                const movedId = itinerary.order.splice(touchStartIndex, 1)[0];
                itinerary.order.splice(dropIndex, 0, movedId);

                saveItinerary(itinerary);
                renderItinerary();
            }

            // Cleanup
            if (touchClone) {
                touchClone.remove();
                touchClone = null;
            }

            document.querySelectorAll('.itinerary-item').forEach(item => {
                item.classList.remove('dragging', 'drag-over');
            });

            touchCurrentItem = null;
            touchStartIndex = null;
        }

        function updateTouchClonePosition(y) {
            if (touchClone) {
                const rect = touchCurrentItem.getBoundingClientRect();
                touchClone.style.left = rect.left + 'px';
                touchClone.style.top = (y - touchClone.offsetHeight / 2) + 'px';
            }
        }

        // Render itinerary
        function renderItinerary() {
            const itinerary = getItinerary();
            const listContainer = document.getElementById('itinerary-list');

            // Use custom order or default to all tour stops
            let orderedIds = itinerary.order && itinerary.order.length > 0
                ? itinerary.order
                : tourData.map(loc => loc.id);

            // Ensure all tour stops are included (in case new ones were added)
            const allTourIds = tourData.map(loc => loc.id);
            allTourIds.forEach(id => {
                if (!orderedIds.includes(id)) {
                    orderedIds.push(id);
                }
            });

            // Filter to only valid stops
            orderedIds = orderedIds.filter(id => tourData.some(loc => loc.id === id));

            // Update progress
            const visitedCount = orderedIds.filter(id => itinerary.visited.includes(id)).length;
            document.getElementById('progress-text').textContent = `${visitedCount} of ${orderedIds.length} completed`;
            document.getElementById('progress-bar').style.width = `${(visitedCount / orderedIds.length) * 100}%`;

            // Render items
            let html = '';
            orderedIds.forEach((stopId, index) => {
                const location = tourData.find(l => l.id === stopId);
                if (!location) return;

                const isVisited = itinerary.visited.includes(stopId);
                const theme = location.civicTheme;
                const themeColor = theme ? theme.color : '#22c55e';

                html += `
                <div class="itinerary-item ${isVisited ? 'visited' : ''}" data-stop-id="${stopId}" data-index="${index}" draggable="true">
                    <div class="itinerary-header">
                        <div class="drag-handle">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16"/>
                            </svg>
                        </div>
                        <div class="stop-number" style="background: ${themeColor};">${index + 1}</div>
                        <div class="checkbox-container ${isVisited ? 'checked' : ''}" onclick="toggleVisited(${stopId}, event)">
                            ${isVisited ? `
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                                </svg>
                            ` : ''}
                        </div>
                        <div class="itinerary-content" onclick="toggleAccordion(${stopId})">
                            <h3 class="item-name text-white font-semibold mb-1">${location.name}</h3>
                            <p class="text-gray-400 text-sm">${location.location}</p>
                        </div>
                        <svg class="chevron-icon w-5 h-5 text-gray-400 flex-shrink-0" onclick="toggleAccordion(${stopId})" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                    <div class="itinerary-details">
                        <div class="p-4 border-t border-gray-800">
                            <p class="text-gray-300 text-sm mb-4">${location.description.substring(0, 150)}...</p>
                            <div class="flex gap-3">
                                <button onclick="openDirections(${location.coordinates[0]}, ${location.coordinates[1]}, '${location.name.replace(/'/g, "\\'")}')"
                                        class="directions-btn flex-1 text-white text-sm" style="background: ${themeColor};">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    Get Directions
                                </button>
                                <a href="location-detail.html?id=${stopId}&tour=${tourId}"
                                   class="directions-btn text-white text-sm border border-gray-600 hover:bg-gray-700">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });

            listContainer.innerHTML = html;

            // Attach drag event listeners
            document.querySelectorAll('.itinerary-item').forEach(item => {
                // Mouse drag
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);

                // Touch drag
                item.addEventListener('touchstart', handleTouchStart, { passive: false });
                item.addEventListener('touchmove', handleTouchMove, { passive: false });
                item.addEventListener('touchend', handleTouchEnd);
            });
        }

        // Initial render
        renderItinerary();

        // ============================================
        // Navigation Drawer
        // ============================================
        const modalsContainer = document.getElementById('modals');

        const tourTypes = [
            {
                id: 'civic-sampler',
                name: 'Freedom Trail Sampler',
                description: '10 stops covering voting, healthcare, housing & more',
                icon: 'üóΩ',
                color: '#22c55e',
                stops: 10
            },
            {
                id: 'healthcare',
                name: 'Healthcare Justice Tour',
                description: 'From colonial medicine to modern healthcare debates',
                icon: 'üè•',
                color: '#EF4444',
                stops: 10
            },
            {
                id: 'voting-rights',
                name: 'Voting Rights Tour',
                description: 'From the Revolution to today - the fight for every vote',
                icon: 'üó≥Ô∏è',
                color: '#8B5CF6',
                stops: 4
            },
            {
                id: 'art-action',
                name: 'ART ACTION TOUR',
                description: 'The role of journalism in democracy',
                icon: 'üé®',
                color: '#F59E0B',
                stops: 4
            }
        ];

        window.showTourMenu = function() {
            modalsContainer.innerHTML = `
                <div class="nav-drawer-overlay" onclick="closeDrawer()"></div>
                <div class="nav-drawer">
                    <div class="nav-drawer-header">
                        <button class="nav-drawer-close" onclick="closeDrawer()">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        <div class="flex flex-col items-center text-center mb-2">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                                </svg>
                            </div>
                            <div class="text-xl font-bold text-white">VoteCraft</div>
                            <div class="text-blue-200 text-sm">Civic Music Tours</div>
                        </div>
                    </div>
                    <div class="nav-drawer-content">
                        <div class="nav-menu-list">
                            <!-- Home -->
                            <a href="#" class="nav-menu-item" onclick="navigateTo('home'); return false;">
                                <svg class="nav-menu-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                                </svg>
                                <span>Home</span>
                            </a>

                            <!-- Tours Accordion -->
                            <div class="accordion">
                                <button class="accordion-trigger nav-menu-item" onclick="toggleTourAccordion(event)" aria-expanded="false">
                                    <div class="flex items-center gap-3">
                                        <svg class="nav-menu-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                        </svg>
                                        <span>Tours</span>
                                    </div>
                                    <svg class="accordion-chevron w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </button>
                                <div class="accordion-content">
                                    ${tourTypes.map(tour => `
                                        <div class="accordion-item ${tour.id === tourId ? 'active' : ''}" onclick="switchTour('${tour.id}')">
                                            <span class="text-xl">${tour.icon}</span>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-white text-sm font-medium truncate">${tour.name}</p>
                                                <p class="text-gray-400 text-xs">${tour.stops} stops</p>
                                            </div>
                                            ${tour.id === tourId ? `
                                                <svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                </svg>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Itinerary -->
                            <a href="#" class="nav-menu-item" style="background: rgba(66, 105, 255, 0.15);">
                                <svg class="nav-menu-icon" style="color: #4269FF;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                                </svg>
                                <span>Itinerary</span>
                            </a>

                            <!-- User/Profile -->
                            <a href="#" class="nav-menu-item" onclick="navigateTo('user'); return false;">
                                <svg class="nav-menu-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <span>Account</span>
                            </a>
                        </div>
                    </div>
                    <div class="nav-drawer-footer">
                        <p class="text-gray-500 text-xs text-center">VoteCraft Boston v1.0</p>
                    </div>
                </div>
            `;

            requestAnimationFrame(() => {
                document.querySelector('.nav-drawer-overlay').classList.add('open');
                document.querySelector('.nav-drawer').classList.add('open');
                document.body.classList.add('drawer-open');
            });
        };

        window.closeDrawer = function() {
            const overlay = document.querySelector('.nav-drawer-overlay');
            const drawer = document.querySelector('.nav-drawer');
            if (overlay) overlay.classList.remove('open');
            if (drawer) drawer.classList.remove('open');
            document.body.classList.remove('drawer-open');
            setTimeout(() => {
                modalsContainer.innerHTML = '';
            }, 300);
        };

        window.toggleTourAccordion = function(event) {
            event.preventDefault();
            const accordion = event.currentTarget.closest('.accordion');
            const trigger = event.currentTarget;
            const isOpen = accordion.classList.contains('open');
            accordion.classList.toggle('open');
            trigger.setAttribute('aria-expanded', !isOpen);
        };

        window.navigateTo = function(destination) {
            switch(destination) {
                case 'home':
                    window.location.href = 'index.html';
                    break;
                case 'user':
                    closeDrawer();
                    break;
            }
        };

        window.switchTour = function(newTourId) {
            window.location.href = `itinerary.html?tour=${newTourId}`;
        };

        // Menu button click handler
        document.getElementById('btn-menu').addEventListener('click', showTourMenu);
    })();
    </script>
</body>
</html>
